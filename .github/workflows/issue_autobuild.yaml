name: Issue Autobuild Workflow (Git-tag versioning)

on:
  issues:
    types:
      - opened

permissions:
  contents: write  # required to push tags
  id-token: write
  packages: write

jobs:
  autobuild:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_RAW: https://raw.githubusercontent.com/simonrob/email-oauth2-proxy/main/emailproxy.py
    steps:
      - name: Check if issue has the "docker-autobuild" label
        id: check-label
        run: |
          if jq '.[].name | select(. == "docker-autobuild")' <<< '${{ toJson(github.event.issue.labels) }}'; then
            has_label="true"
          else
            has_label="false"
          fi
          echo "has_label=$has_label" >> $GITHUB_ENV

      - name: Checkout full repo (fetch tags)
        if: env.has_label == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute date-based version tag
        if: env.has_label == 'true'
        id: compute-version
        run: |
          DATE=$(date +"%Y.%m.%d")
          # fetch remote tags
          git fetch --tags origin || true
          # list tags starting with DATE or DATE.*
          TAGS=$(git tag -l "${DATE}*" || true)
          if [ -z "$TAGS" ]; then
            # No existing tag for today -> use bare date
            VERSION="$DATE"
          else
            # Determine highest numeric suffix among tags like DATE.N
            MAX=0
            for t in $TAGS; do
              # If tag equals DATE, treat as base and consider NEXT=1
              if [ "$t" = "$DATE" ]; then
                n=0
              else
                # extract suffix after last dot
                n=${t##*.}
                case "$n" in
                  ''|*[!0-9]*) n=0;;
                esac
              fi
              if [ "$n" -gt "$MAX" ]; then MAX=$n; fi
            done
            NEXT=$((MAX + 1))
            VERSION="${DATE}.${NEXT}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Computed version: $VERSION"

      - name: Create and push git tag
        if: env.has_label == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # create annotated tag if it doesn't already exist
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists locally"
          else
            git tag -a "$VERSION" -m "autobuild $VERSION"
          fi
          git push origin "$VERSION" || echo "Tag push failed (check permissions)"

      - name: Download upstream file
        if: env.has_label == 'true'
        run: |
          curl -sL "$UPSTREAM_RAW" -o emailproxy.py

      - name: Build image
        if: env.has_label == 'true'
        run: |
          docker build . -t email-oauth2-proxy-docker
          docker tag email-oauth2-proxy-docker ghcr.io/blacktirion/email-oauth2-proxy-docker:${{ env.VERSION }}
          docker tag email-oauth2-proxy-docker ghcr.io/blacktirion/email-oauth2-proxy-docker:latest
          docker tag email-oauth2-proxy-docker blacktirion/email-oauth2-proxy-docker:${{ env.VERSION }}
          docker tag email-oauth2-proxy-docker blacktirion/email-oauth2-proxy-docker:latest

      - name: Push image
        if: env.has_label == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GHCR login using GITHUB_TOKEN works if permissions allow; otherwise configure a PAT
          echo "Pushing images (requires appropriate secrets)"
          echo "Ensure secrets.DOCKERHUB_USERNAME and DOCKERHUB_TOKEN exist for Docker Hub pushes"
          docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} || true
          docker push ghcr.io/blacktirion/email-oauth2-proxy-docker:${{ env.VERSION }} || true
          docker push ghcr.io/blacktirion/email-oauth2-proxy-docker:latest || true
          docker login docker.io -u ${{ secrets.DOCKERHUB_USERNAME }} -p "${{ secrets.DOCKERHUB_TOKEN }}" || true
          docker push blacktirion/email-oauth2-proxy-docker:${{ env.VERSION }} || true
          docker push blacktirion/email-oauth2-proxy-docker:latest || true
