name: Dev Build Workflow

on:
  workflow_dispatch:
    inputs:
      skip_push:
        description: "Set to true to run build steps without pushing tags or images"
        required: false
        default: "false"
concurrency:
  group: 'dev-build-${{ github.repository }}'
  cancel-in-progress: false

env:
  DOCKERHUB_IMAGE_NAME: "docker.io/blacktirion/email-oauth2-proxy-docker"

jobs:
  check-issue-label:
    runs-on: ubuntu-latest
    outputs:
      has_label: ${{ steps.check-label.outputs.has_label }}
    steps:
      - name: Check trigger type
        id: check-label
        run: |
          # Always allow workflow_dispatch
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "has_label=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_label=false" >> "$GITHUB_OUTPUT"
          fi

  autobuild-dev:
    needs: check-issue-label
    runs-on: ubuntu-latest
    if: ${{ needs.check-issue-label.outputs.has_label == 'true' }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code (full history for tags)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set SKIP_PUSH (from workflow_dispatch input)
        run: |
          SKIP_PUSH="${{ github.event.inputs.skip_push || 'false' }}"
          echo "SKIP_PUSH=$SKIP_PUSH" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Detect Docker Hub credentials
        id: detect_dockerhub
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "has_dockerhub=true" >> $GITHUB_OUTPUT
          else
            echo "has_dockerhub=false" >> $GITHUB_OUTPUT
          fi
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Log in to Docker.io (if credentials provided)
        if: ${{ steps.detect_dockerhub.outputs.has_dockerhub == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Fetch tags
        run: |
          # ensure we can list tags (works for shallow clones too)
          git fetch --prune --unshallow || true
          git fetch --tags origin || true

      - name: Generate date-based version tag (YYYY.MM.DD.N)
        id: generate-version
        run: |
          DATE=$(date +"%Y.%m.%d")
          TAGS=$(git tag -l "${DATE}*")
          if [ -z "$TAGS" ]; then
            NEXT=1
          else
            MAX=0
            for t in $TAGS; do
              SFX=${t##*.}
              if [[ "$SFX" =~ ^[0-9]+$ ]]; then
                if [ "$SFX" -gt "$MAX" ]; then MAX=$SFX; fi
              fi
            done
            NEXT=$((MAX + 1))
          fi
          VERSION="${DATE}.${NEXT}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Computed VERSION=$VERSION"

      # Note: For dev builds, we might not want to push the git tag to avoid confusion with release tags.
      # However, keeping the logic here so the VERSION env var is populated.
      # We disable the git push for dev builds to behave like a 'test' run unless explicitly needed.
      # If you want dev builds to create git tags, uncomment the git push line.
      - name: Create version var (Simulation for Dev)
        run: |
          echo "Dev build: using version $VERSION-dev"

      - name: Download upstream dependency (emailproxy.py)
        run: |
          curl -fsSL -o emailproxy.py https://raw.githubusercontent.com/simonrob/email-oauth2-proxy/main/emailproxy.py

      - name: Build and push HEADLESS images (DEV)
        uses: docker/build-push-action@v6
        with:
          context: .
          target: headless
          push: ${{ env.SKIP_PUSH != 'true' }}
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository }}:dev
            ghcr.io/${{ github.repository }}:${{ env.VERSION }}-dev
            ${{ env.DOCKERHUB_IMAGE_NAME }}:dev
            ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ env.VERSION }}-dev

      - name: Build and push GUI images (DEV)
        uses: docker/build-push-action@v6
        with:
          context: .
          target: gui
          push: ${{ env.SKIP_PUSH != 'true' }}
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository }}:gui-dev
            ghcr.io/${{ github.repository }}:${{ env.VERSION }}-gui-dev
            ${{ env.DOCKERHUB_IMAGE_NAME }}:gui-dev
            ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ env.VERSION }}-gui-dev
