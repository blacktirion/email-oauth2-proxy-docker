name: Issue Autobuild Workflow

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      skip_push:
        description: 'Set to true to run build steps without pushing tags or images'
        required: false
        default: 'false'

concurrency:
  group: 'autobuild-${{ github.repository }}'
  cancel-in-progress: false

jobs:
  check-issue-label:
    runs-on: ubuntu-latest
    outputs:
      has_label: ${{ steps.check-label.outputs.has_label }}
    steps:
      - name: Check if issue has the "docker-autobuild" label or allow manual runs
        id: check-label
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "has_label=true" >> "$GITHUB_OUTPUT"
          else
            if jq '.[].name | select(. == "docker-autobuild")' <<< '${{ toJson(github.event.issue.labels) }}'; then
              echo "has_label=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_label=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  autobuild-if-issue:
    needs: check-issue-label
    runs-on: ubuntu-latest
    if: ${{ needs.check-issue-label.outputs.has_label == 'true' }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set SKIP_PUSH (from workflow_dispatch input)
        run: |
          SKIP_PUSH="${{ github.event.inputs.skip_push || 'false' }}"
          echo "SKIP_PUSH=$SKIP_PUSH" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker.io (if credentials provided)
        if: ${{ secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Fetch tags
        run: |
          # ensure we can list tags (works for shallow clones too)
          git fetch --prune --unshallow || true
          git fetch --tags origin || true

      - name: Generate date-based version tag (YYYY.MM.DD.N)
        id: generate-version
        run: |
          DATE=$(date +"%Y.%m.%d")
          TAGS=$(git tag -l "${DATE}*")
          if [ -z "$TAGS" ]; then
            NEXT=1
          else
            MAX=0
            for t in $TAGS; do
              SFX=${t##*.}
              if [[ "$SFX" =~ ^[0-9]+$ ]]; then
                if [ "$SFX" -gt "$MAX" ]; then MAX=$SFX; fi
              fi
            done
            NEXT=$((MAX + 1))
          fi
          VERSION="${DATE}.${NEXT}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Computed VERSION=$VERSION"

      - name: Create annotated tag (skip if SKIP_PUSH=true)
        run: |
          if [ "$SKIP_PUSH" = "true" ]; then
            echo "Skipping tag creation because SKIP_PUSH=true"
            exit 0
          fi
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git tag -a "$VERSION" -m "autobuild $VERSION"
          git push origin "$VERSION"

      - name: Download upstream dependency (emailproxy.py)
        run: |
          # Consider pinning to upstream tag/commit for more safety; currently pulls main
          curl -fsSL -o emailproxy.py https://raw.githubusercontent.com/simonrob/email-oauth2-proxy/main/emailproxy.py

      - name: Build and optionally push images (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ env.SKIP_PUSH != 'true' }}
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ env.VERSION }}
            docker.io/${{ github.repository }}:latest
            docker.io/${{ github.repository }}:${{ env.VERSION }}
